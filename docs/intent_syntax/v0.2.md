# Intent Language Specification â€” v0.2

> This document describes **new features** in v0.2. For base syntax, see [v0.1](./v0.1.md).

---

## 1. Process Section: Function Calls

v0.2 extends `derive` statements to support **function calls** in addition to literals and field access.

### 1.1 Syntax

```intent
process:
    derive variable = function_name(arg1, arg2, ...)
```

### 1.2 Function Arguments

Arguments can be:

| Type | Example | Description |
|------|---------|-------------|
| Entity name | `User` | References an entity type |
| Identifier | `email` | References an input field |
| Dotted path | `user.email` | References a derived variable's field |
| Literal | `"active"`, `42` | String or number literal |

---

## 2. Built-in Functions

### 2.1 `find(Entity, field1, field2, ...)`

Queries an entity by one or more input fields.

```intent
derive user = find(User, email)
derive order = find(Order, user_id, status)
```

**Generated code:**
```python
user = db.query(UserModel).filter(UserModel.email == data.email).first()
order = db.query(OrderModel).filter(
    OrderModel.user_id == data.user_id,
    OrderModel.status == data.status
).first()
```

**Behavior:**
- First argument is the entity to query
- Remaining arguments are input fields used as filter conditions
- Returns `None` if not found (action should handle this)

---

### 2.2 `verify_hash(input_field, hash_field)`

Verifies a plaintext input against a hashed value.

```intent
derive valid = verify_hash(password, user.password_hash)
```

**Generated code:**
```python
if not verify_password(data.password, user.password_hash):
    raise HTTPException(status_code=400, detail="Invalid credentials")
```

**Use case:** Password verification during login.

---

### 2.3 `create_jwt(subject)`

Creates a JWT access token with the given subject.

```intent
derive token = create_jwt(user.email)
```

**Generated code:**
```python
token = create_access_token(data={"sub": user.email})
```

**Use case:** Token generation for authentication.

---

## 3. Query-Based Actions

When a `process:` section contains `find()`, the compiler generates **query logic** instead of create logic for POST actions.

### Example: Login Action

```intent
@api POST /login
action login:
    input:
        email: email
        password: string
    process:
        derive user = find(User, email)
        derive valid = verify_hash(password, user.password_hash)
        derive token = create_jwt(user.email)
    output: User(id, token)
```

**Generated behavior:**
1. Query user by email
2. Raise 400 if not found
3. Verify password, raise 400 if invalid
4. Create JWT token
5. Return `{id, token}`

---

## 4. Grammar Changes

```ebnf
(* Updated derive expression *)
derive_expr     ::= function_call | dotted_path | literal | identifier

(* New: function call *)
function_call   ::= IDENTIFIER "(" function_args? ")"
function_args   ::= function_arg ("," function_arg)*
function_arg    ::= dotted_path | TYPE_NAME | literal | IDENTIFIER
```

---

## 5. Migration from v0.1

v0.2 is **fully backward compatible** with v0.1. Existing `.intent` files work without changes.

To use new features, add function calls to `process:` sections as needed.
